name: Test ARM64 Linux Build

on:
  push:
    branches:
      - add-arm64-linux-nif

jobs:
  build_arm64_linux:
    name: NIF 2.15 - aarch64-unknown-linux-gnu (ubuntu-22.04)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Extract crate information
        shell: bash
        run: |
          echo "PROJECT_VERSION=$(sed -n 's/^  @version "\(.*\)"/\1/p' mix.exs | head -n1)" >> $GITHUB_ENV

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config patchelf

      - name: Add target
        shell: bash
        run: |
          rustup target add aarch64-unknown-linux-gnu

      - name: Install cross (for cross-compilation)
        shell: bash
        run: |
          cargo install cross --git https://github.com/cross-rs/cross

      - name: Install cross-compilation tools (Linux ARM64)
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build the project
        id: build-crate
        uses: philss/rustler-precompiled-action@v1.1.4
        with:
          project-name: extractousex_native
          project-version: ${{ env.PROJECT_VERSION }}
          target: aarch64-unknown-linux-gnu
          nif-version: "2.15"
          use-cross: true

      - name: Modify archive to fix library paths
        shell: bash
        run: |
          set -euo pipefail

          TEMP_DIR=$(mktemp -d)

          tar -xzf "${{ steps.build-crate.outputs.file-path }}" -C "$TEMP_DIR" || {
              echo "::error::Failed to extract archive"; exit 1;
          }

          NIF_LIB=$(find "$TEMP_DIR" -type f -name "libextractousex_native*") || {
              echo "::error::Failed to search for NIF library"; exit 1;
          }

          if [ -z "$NIF_LIB" ]; then
              echo "::error::Could not find NIF library in archive"
              echo "Archive contents:"
              ls -la "$TEMP_DIR"
              exit 1
          fi

          # Find libtika_native library in the build directory
          TIKA_LIB=$(find target -type f \( -name "libtika_native.so" -o -name "libtika_native.dylib" \) -path "*/nativeCompile/*" 2>/dev/null | head -1)
          if [ -z "$TIKA_LIB" ]; then
              TIKA_LIB=$(find target -type f \( -name "libtika_native.so" -o -name "libtika_native.dylib" \) -path "*/libs/*" 2>/dev/null | head -1)
          fi

          echo "Found tika library at: $TIKA_LIB"

          if [ -z "$TIKA_LIB" ]; then
              echo "::error::Could not find libtika_native library (.so, .dylib)"
              if [ -d "target" ]; then
                  echo "Directory contents of target (all libtika_native files):"
                  find target -type f -name "libtika_native.*" -exec ls -la {} \;
              fi
              exit 1
          fi

          # Copy the tika library to the archive
          cp "$TIKA_LIB" "$TEMP_DIR/$(basename "$TIKA_LIB")"

          # Copy any additional native libraries from extractous
          LIBS=$(find target -type d -path "*/extractous-*/out/libs" 2>/dev/null)
          for dir in $LIBS; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* "$TEMP_DIR" 2>/dev/null || true
            fi
          done

          # Fix Linux library paths
          echo "Fixing Linux library paths..."
          patchelf --set-rpath '$ORIGIN' "$NIF_LIB"

          # Re-package the archive
          cd "$TEMP_DIR" || exit 1
          tar -czf archive.tar.gz ./* || {
              echo "::error::Failed to create new archive"
              exit 1
          }
          cd - || exit 1

          mv "$TEMP_DIR/archive.tar.gz" "${{ steps.build-crate.outputs.file-path }}" || {
              echo "::error::Failed to move new archive"
              exit 1
          }

          rm -rf "$TEMP_DIR"

      - name: Artifact upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build-crate.outputs.file-name }}
          path: ${{ steps.build-crate.outputs.file-path }}
